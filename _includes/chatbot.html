<!-- Reality Lab Chatbot -->
<div id="chatbot-container" class="chatbot-container" style="display: none;">
  
  <div id="chatbot-window" class="chatbot-window">
    <div class="chatbot-header">
      <div class="chatbot-header-info">
        <div class="chatbot-title">Reality Lab Assistant</div>
        <div class="chatbot-subtitle">AIê°€ ì—°êµ¬ì‹¤ì— ëŒ€í•´ ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤!</div>
      </div>
      <div class="chatbot-controls">
        <div class="mode-toggle">
          <div class="toggle-labels">
            <span class="toggle-label search-label">ê²€ìƒ‰</span>
            <span class="toggle-label ai-label active">AI</span>
          </div>
          <div class="toggle-switch">
            <input type="checkbox" id="mode-toggle" class="toggle-input" checked>
            <label for="mode-toggle" class="toggle-slider"></label>
          </div>
        </div>
        <button id="chatbot-close" class="chatbot-close">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div id="chatbot-messages" class="chatbot-messages">
      <div class="message bot-message">
        <div class="message-content">
          ì•ˆë…•í•˜ì„¸ìš”! Reality Lab Assistantì…ë‹ˆë‹¤. ğŸ¤–<br>
          ì—°êµ¬ì‹¤ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!
        </div>
      </div>
    </div>
    
    <div class="chatbot-input-container">
      <input type="text" id="chatbot-input" class="chatbot-input" placeholder="ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”..." maxlength="200">
      <button id="chatbot-send" class="chatbot-send">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 2L9 11M18 2L12 18L9 11M18 2L2 8L9 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    
    <div class="chatbot-suggestions">
      <div class="suggestion-chips">
        <button class="suggestion-chip" data-question="ì—°êµ¬ ë¶„ì•¼ê°€ ë­”ê°€ìš”?" data-question-en="What are your research areas?">ì—°êµ¬ ë¶„ì•¼</button>
        <button class="suggestion-chip" data-question="íŒ€ êµ¬ì„±ì›ì€ ëˆ„êµ¬ì¸ê°€ìš”?" data-question-en="Who are the team members?">íŒ€ êµ¬ì„±ì›</button>
        <button class="suggestion-chip" data-question="ì—°êµ¬ì‹¤ì— ì§€ì›í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?" data-question-en="How can I apply to the lab?">ì§€ì› ë°©ë²•</button>
        <button class="suggestion-chip" data-question="ì—°ë½ì²˜ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”" data-question-en="Please provide contact information">ì—°ë½ì²˜</button>
      </div>
      
      <div class="language-buttons">
        <button class="lang-btn active" data-lang="ko">KOR</button>
        <button class="lang-btn" data-lang="en">ENG</button>
      </div>
    </div>
  </div>
</div>

<style>
/* Chatbot Styles */
.chatbot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.chatbot-window {
  position: absolute;
  bottom: 80px;
  right: 0;
  width: 450px;
  height: 600px;
  min-width: 320px;
  min-height: 400px;
  max-width: 800px;
  max-height: 800px;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  display: none;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  resize: both;
  overflow: hidden;
}

.chatbot-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  cursor: move;
  user-select: none;
  background: linear-gradient(135deg, rgba(51, 102, 204, 0.1) 0%, rgba(41, 84, 179, 0.15) 100%);
  backdrop-filter: blur(10px);
  border-radius: 16px 16px 0 0;
}

.chatbot-title {
  font-size: 16px;
  font-weight: 600;
  color: #1a1a1a;
}

.chatbot-subtitle {
  font-size: 12px;
  color: #6b7280;
  margin-top: 2px;
}

.chatbot-close {
  background: none;
  border: none;
  cursor: pointer;
  color: #6b7280;
  padding: 4px;
  border-radius: 6px;
}

.chatbot-close:hover {
  background: rgba(0, 0, 0, 0.05);
}

.chatbot-controls {
  display: flex;
  align-items: center;
  gap: 16px;
}

.mode-toggle {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.toggle-labels {
  display: flex;
  gap: 8px;
  font-size: 11px;
  font-weight: 500;
}

.toggle-label {
  color: #6b7280;
  transition: color 0.2s ease;
}

.toggle-label.active {
  color: #3366cc;
  font-weight: 600;
}

.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
}

.toggle-input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #3366cc;
  border-radius: 24px;
  transition: all 0.3s ease;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 0px;
  top: -2px;
  background: white;
  border-radius: 50%;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toggle-input:checked + .toggle-slider {
  background: #10b981;
}

.toggle-input:checked + .toggle-slider:before {
  transform: translateX(25px);
}

.chatbot-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.message {
  display: flex;
  flex-direction: column;
}

.bot-message .message-content {
  background: #f3f4f6;
  color: #1a1a1a;
  border-radius: 18px 18px 18px 4px;
  padding: 12px 16px;
  max-width: 85%;
  font-size: 14px;
  line-height: 1.4;
}

.user-message {
  align-items: flex-end;
}

.user-message .message-content {
  background: #3366cc;
  color: white;
  border-radius: 18px 18px 4px 18px;
  padding: 12px 16px;
  max-width: 85%;
  font-size: 14px;
  line-height: 1.4;
}

.chatbot-input-container {
  display: flex;
  padding: 16px 20px 10px;
  gap: 12px;
}

.chatbot-input {
  flex: 1;
  border: 2px solid #e5e7eb;
  border-radius: 24px;
  padding: 12px 16px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s ease;
}

.chatbot-input:focus {
  border-color: #3366cc;
}

.chatbot-send {
  background: #3366cc;
  color: white;
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s ease;
}

.chatbot-send:hover {
  background: #2954b3;
}

.chatbot-suggestions {
  padding: 10px 20px 20px;
}

.suggestion-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.suggestion-chip {
  background: rgba(51, 102, 204, 0.1);
  color: #3366cc;
  border: 1px solid rgba(51, 102, 204, 0.2);
  border-radius: 16px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.suggestion-chip:hover {
  background: rgba(51, 102, 204, 0.2);
}

.language-buttons {
  display: flex;
  gap: 6px;
  justify-content: flex-end;
  margin-top: 12px;
}

.lang-btn {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(10px) saturate(1.8);
  -webkit-backdrop-filter: blur(10px) saturate(1.8);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  padding: 4px 8px;
  font-size: 10px;
  font-weight: 600;
  color: #6b7280;
  cursor: pointer;
  transition: all 0.3s ease;
  user-select: none;
}

.lang-btn:hover {
  background: rgba(255, 255, 255, 0.4);
  border: 1px solid rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.lang-btn.active {
  background: rgba(51, 102, 204, 0.2);
  border: 1px solid rgba(51, 102, 204, 0.3);
  color: #3366cc;
  box-shadow: 0 2px 8px rgba(51, 102, 204, 0.2);
}

/* Mobile responsive */
@media (max-width: 768px) {
  .chatbot-container {
    bottom: 15px;
    right: 15px;
    left: 15px;
  }
  
  .chatbot-window {
    width: 100%;
    height: 70vh;
    bottom: 70px;
    left: 0;
    right: 0;
    position: fixed;
  }
  
  .chatbot-toggle {
    width: fit-content;
    margin-left: auto;
  }
  
  .chatbot-text {
    display: none;
  }
}
</style>

<script>
// Chatbot Knowledge Base (injected from Jekyll data)
const knowledgeBase = {{ site.data.chatbot_knowledge | jsonify }};

// Chatbot functionality
document.addEventListener('DOMContentLoaded', function() {
  const chatbotToggle = document.getElementById('chatbot-toggle');
  const chatbotWindow = document.getElementById('chatbot-window');
  const chatbotClose = document.getElementById('chatbot-close');
  const aiSearchBtn = document.getElementById('ai-search');
  const chatbotInput = document.getElementById('chatbot-input');
  const chatbotSend = document.getElementById('chatbot-send');
  const chatbotMessages = document.getElementById('chatbot-messages');
  const suggestionChips = document.querySelectorAll('.suggestion-chip');
  
  // Mode toggle elements
  const modeToggle = document.getElementById('mode-toggle');
  const searchLabel = document.querySelector('.search-label');
  const aiLabel = document.querySelector('.ai-label');
  const chatbotSubtitle = document.querySelector('.chatbot-subtitle');
  const chatbotTitle = document.querySelector('.chatbot-title');
  
  // Language button elements
  const langButtons = document.querySelectorAll('.lang-btn');
  const suggestionChipsElements = document.querySelectorAll('.suggestion-chip');
  
  // Current modes
  let isAIMode = true;
  let isEnglish = false;

  // Toggle chatbot
  function toggleChatbot() {
    const container = document.getElementById('chatbot-container');
    if (chatbotWindow.style.display === 'flex') {
      chatbotWindow.style.display = 'none';
    } else {
      container.style.display = 'block';
      chatbotWindow.style.display = 'flex';
    }
  }
  
  // AI Search button in navigation
  if (aiSearchBtn) {
    aiSearchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      toggleChatbot();
    });
  }

  chatbotClose.addEventListener('click', () => {
    const container = document.getElementById('chatbot-container');
    chatbotWindow.style.display = 'none';
    container.style.display = 'none';
  });

  // Mode toggle functionality
  if (modeToggle) {
    modeToggle.addEventListener('change', function() {
      isAIMode = this.checked;
      updateModeUI();
    });
  }

  function updateModeUI() {
    updateAllUI();
  }

  // Language button functionality
  langButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const lang = this.getAttribute('data-lang');
      isEnglish = (lang === 'en');
      updateLanguageUI();
    });
  });

  function updateLanguageUI() {
    updateAllUI();
  }

  function updateAllUI() {
    // Update language button states
    langButtons.forEach(btn => {
      const lang = btn.getAttribute('data-lang');
      if ((lang === 'en' && isEnglish) || (lang === 'ko' && !isEnglish)) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    // Update suggestion chips
    suggestionChipsElements.forEach(chip => {
      if (isEnglish) {
        const englishText = chip.getAttribute('data-question-en');
        const englishLabels = ['Research Areas', 'Team Members', 'Application', 'Contact'];
        const index = Array.from(suggestionChipsElements).indexOf(chip);
        chip.textContent = englishLabels[index];
        chip.setAttribute('data-question', englishText);
      } else {
        const koreanText = chip.getAttribute('data-question');
        const koreanLabels = ['ì—°êµ¬ ë¶„ì•¼', 'íŒ€ êµ¬ì„±ì›', 'ì§€ì› ë°©ë²•', 'ì—°ë½ì²˜'];
        const index = Array.from(suggestionChipsElements).indexOf(chip);
        chip.textContent = koreanLabels[index];
      }
    });

    // Update mode labels and content based on current language
    if (isAIMode) {
      searchLabel.classList.remove('active');
      aiLabel.classList.add('active');
      if (isEnglish) {
        chatbotTitle.textContent = 'Reality Lab Assistant';
        chatbotSubtitle.textContent = 'AI will answer about our research lab!';
        chatbotInput.placeholder = 'Ask AI anything about our lab...';
      } else {
        chatbotTitle.textContent = 'Reality Lab Assistant';
        chatbotSubtitle.textContent = 'AIê°€ ì—°êµ¬ì‹¤ì— ëŒ€í•´ ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤!';
        chatbotInput.placeholder = 'AIì—ê²Œ ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”...';
      }
    } else {
      searchLabel.classList.add('active');
      aiLabel.classList.remove('active');
      if (isEnglish) {
        chatbotTitle.textContent = 'Reality Lab Assistant';
        chatbotSubtitle.textContent = 'Ask anything about our research lab!';
        chatbotInput.placeholder = 'Ask anything about our lab...';
      } else {
        chatbotTitle.textContent = 'Reality Lab Assistant';
        chatbotSubtitle.textContent = 'ì—°êµ¬ì‹¤ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”!';
        chatbotInput.placeholder = 'ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”...';
      }
    }
  }

  // Handle input
  function handleSend() {
    const question = chatbotInput.value.trim();
    if (!question) return;

    // Add user message
    addMessage(question, 'user');
    chatbotInput.value = '';

    // Generate and add bot response
    setTimeout(() => {
      let answer;
      if (isAIMode) {
        // AI mode - show "not implemented" message
        if (isEnglish) {
          answer = "Sorry, AI mode is still in preparation. ğŸ¤–<br>Currently only Search mode is available. Please switch the toggle to 'Search'.";
        } else {
          answer = "ì£„ì†¡í•©ë‹ˆë‹¤. AI ëª¨ë“œëŠ” ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ğŸ¤–<br>í˜„ì¬ëŠ” ê²€ìƒ‰ ëª¨ë“œë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. í† ê¸€ì„ 'ê²€ìƒ‰'ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.";
        }
      } else {
        // Search mode - use existing knowledge base
        answer = generateAnswer(question);
      }
      addMessage(answer, 'bot');
    }, 500);
  }

  chatbotSend.addEventListener('click', handleSend);
  chatbotInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      handleSend();
    }
  });

  // Suggestion chips
  suggestionChips.forEach(chip => {
    chip.addEventListener('click', () => {
      const question = chip.dataset.question;
      chatbotInput.value = question;
      handleSend();
    });
  });

  // Add message to chat
  function addMessage(content, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = content.replace(/\n/g, '<br>');
    
    messageDiv.appendChild(contentDiv);
    chatbotMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
  }

  // Simple knowledge-based answer generation
  function generateAnswer(question) {
    const q = question.toLowerCase();
    
    // Check custom Q&A first
    for (const qa of knowledgeBase.custom_qa) {
      if (q.includes(qa.question.toLowerCase()) || 
          qa.question.toLowerCase().includes(q) ||
          checkSimilarity(q, qa.question.toLowerCase())) {
        return qa.answer;
      }
    }
    
    // Research areas
    for (const area of knowledgeBase.research_areas) {
      for (const keyword of area.keywords) {
        if (q.includes(keyword.toLowerCase()) || q.includes(area.name.toLowerCase())) {
          return `${area.name}: ${area.description}`;
        }
      }
    }
    
    // Team members
    if (q.includes('íŒ€') || q.includes('êµ¬ì„±ì›') || q.includes('ë©¤ë²„') || q.includes('ì‚¬ëŒ')) {
      let teamInfo = "Reality Lab íŒ€ êµ¬ì„±ì›ë“¤ì„ ì†Œê°œí•´ë“œë¦´ê²Œìš”:\n\n";
      knowledgeBase.team_members.forEach(member => {
        teamInfo += `â€¢ ${member.name} - ${member.role}\n`;
      });
      return teamInfo;
    }
    
    // Lab info
    if (q.includes('ì—°êµ¬ì‹¤') || q.includes('ë©') || q.includes('ì†Œê°œ')) {
      return `${knowledgeBase.lab_info.full_name}ì€ ${knowledgeBase.lab_info.established}ë…„ì— ì„¤ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤. ${knowledgeBase.lab_info.director}ë‹˜ì´ ì´ë„ì‹œë©°, ${knowledgeBase.lab_info.mission}`;
    }
    
    // Contact info
    if (q.includes('ì—°ë½') || q.includes('ì´ë©”ì¼') || q.includes('ì „í™”') || q.includes('ì—°ë½ì²˜')) {
      return `ì—°ë½ì²˜ ì •ë³´ì…ë‹ˆë‹¤:\nâ€¢ ì´ë©”ì¼: ${knowledgeBase.lab_info.email}\nâ€¢ ì „í™”: ${knowledgeBase.lab_info.phone}\nâ€¢ ìœ„ì¹˜: ${knowledgeBase.lab_info.location}`;
    }
    
    // Location
    if (q.includes('ìœ„ì¹˜') || q.includes('ì–´ë””')) {
      return `Reality Labì€ ${knowledgeBase.lab_info.location}ì— ìœ„ì¹˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.`;
    }
    
    // Fallback
    const fallbacks = knowledgeBase.fallback_responses;
    return fallbacks[Math.floor(Math.random() * fallbacks.length)];
  }

  // Simple similarity check
  function checkSimilarity(str1, str2) {
    const words1 = str1.split(' ');
    const words2 = str2.split(' ');
    let matchCount = 0;
    
    words1.forEach(word1 => {
      if (words2.some(word2 => word2.includes(word1) || word1.includes(word2))) {
        matchCount++;
      }
    });
    
    return matchCount >= Math.min(words1.length, words2.length) * 0.4;
  }

  // Drag functionality
  let isDragging = false;
  let currentX = 0;
  let currentY = 0;
  let initialX = 0;
  let initialY = 0;
  let xOffset = 0;
  let yOffset = 0;

  const chatbotHeader = document.querySelector('.chatbot-header');
  
  if (chatbotHeader) {
    chatbotHeader.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);
  }

  function dragStart(e) {
    if (e.target === chatbotClose || e.target.closest('.chatbot-close')) return;
    
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;

    if (e.target === chatbotHeader || chatbotHeader.contains(e.target)) {
      isDragging = true;
      chatbotWindow.style.transition = 'none';
    }
  }

  function dragMove(e) {
    if (isDragging) {
      e.preventDefault();
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;

      xOffset = currentX;
      yOffset = currentY;

      // Convert to fixed positioning when dragging
      if (chatbotWindow.style.position !== 'fixed') {
        const rect = chatbotWindow.getBoundingClientRect();
        chatbotWindow.style.position = 'fixed';
        chatbotWindow.style.bottom = 'auto';
        chatbotWindow.style.right = 'auto';
        chatbotWindow.style.top = rect.top + 'px';
        chatbotWindow.style.left = rect.left + 'px';
      }

      chatbotWindow.style.transform = `translate(${currentX}px, ${currentY}px)`;
    }
  }

  function dragEnd(e) {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
    chatbotWindow.style.transition = '';
  }
});
</script>