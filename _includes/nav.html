<!-- Navigation -->
<nav
  class="navbar navbar-expand-lg navbar-light fixed-top"
  id="mainNav"
  style="background: transparent !important; backdrop-filter: none !important;"
>
  <div class="container">
    <a class="navbar-brand js-scroll-trigger" href="{{ site.baseurl }}/" id="reality-lab-logo">
      {%- if site.logo -%}
      <img
        height="{{ site.logo.height | default: 52 }}"
        src="{{ site.logo.path }}"
      />
      {%- else -%} {{ site.title }} {%- endif -%}
    </a>
    <button
      class="navbar-toggler navbar-toggler-right"
      type="button"
      data-toggle="collapse"
      data-target="#navbarResponsive"
      aria-controls="navbarResponsive"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      Menu<i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav text-uppercase ml-auto">
      {% if site.locale and site.locale != "" and site.locale != nil %}
        {%- for link in site.data.navigation[site.locale].nav -%}
        <li class="nav-item {% if link.dropdown %}dropdown{% endif %}">
          {%- if link.dropdown -%}
          <a class="nav-link dropdown-toggle{% if link.title == 'AI' %} ai-menu-circular{% endif %}" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
            {% if link.title == 'AI' %}<svg width="22" height="22" viewBox="0 0 512 512"><defs><linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" /><stop offset="50%" style="stop-color:#2563EB;stop-opacity:1" /><stop offset="100%" style="stop-color:#1D4ED8;stop-opacity:1" /></linearGradient></defs><path fill="url(#blueGradient)" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>{% else %}{{ link.title }} <span class="dropdown-arrow" style="margin-left: 8px; color: #007bff; font-size: 14px; font-weight: bold;">&#9662;</span>{% endif %}
          </a>
          <div class="dropdown-menu">
            {%- for item in link.dropdown -%}
            <a class="dropdown-item{% if item.class %} {{ item.class }}{% endif %}" href="{{ item.url }}"{% if item.onclick %} onclick="{{ item.onclick }}"{% endif %}>
              <div class="dropdown-item-content">
                {% if item.icon %}<i class="{{ item.icon }}"></i>{% endif %}
                <div class="dropdown-item-text">
                  <strong>{{ item.title }}</strong>
                  {% if item.desc %}<small>{{ item.desc }}</small>{% endif %}
                </div>
              </div>
            </a>
            {%- endfor -%}
          </div>
          {%- elsif link.url -%}
          <a class="nav-link{% unless link.external_page %} js-scroll-trigger{% endunless %}" href="{{ link.url }}"
            >{{ link.title }}</a
          >
          {%- elsif link.section -%}
          <a
            class="nav-link js-scroll-trigger"
            href="{{ site.baseurl }}/#{{ link.section }}"
            >{{ link.title }}</a
          >
          {%- else -%}
          <a class="nav-link js-scroll-trigger" href="#">{{ link.title }}</a>
          {%- endif -%}
        </li>
        {%- endfor -%}
      {% else %}
        {%- for link in site.data.navigation.nav -%}
        <li class="nav-item {% if link.dropdown %}dropdown{% endif %}">
          {%- if link.dropdown -%}
          <a class="nav-link dropdown-toggle{% if link.title == 'AI' %} ai-menu-circular{% endif %}" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
            {% if link.title == 'AI' %}<svg width="22" height="22" viewBox="0 0 512 512"><defs><linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" /><stop offset="50%" style="stop-color:#2563EB;stop-opacity:1" /><stop offset="100%" style="stop-color:#1D4ED8;stop-opacity:1" /></linearGradient></defs><path fill="url(#blueGradient)" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>{% else %}{{ link.title }} <span class="dropdown-arrow" style="margin-left: 8px; color: #007bff; font-size: 14px; font-weight: bold;">&#9662;</span>{% endif %}
          </a>
          <div class="dropdown-menu">
            {%- for item in link.dropdown -%}
            <a class="dropdown-item{% if item.class %} {{ item.class }}{% endif %}" href="{{ item.url }}"{% if item.onclick %} onclick="{{ item.onclick }}"{% endif %}>
              <div class="dropdown-item-content">
                {% if item.icon %}<i class="{{ item.icon }}"></i>{% endif %}
                <div class="dropdown-item-text">
                  <strong>{{ item.title }}</strong>
                  {% if item.desc %}<small>{{ item.desc }}</small>{% endif %}
                </div>
              </div>
            </a>
            {%- endfor -%}
          </div>
          {%- elsif link.url -%}
          <a class="nav-link{% unless link.external_page %} js-scroll-trigger{% endunless %}" href="{{ link.url }}"
            >{{ link.title }}</a
          >
          {%- elsif link.section -%}
          <a
            class="nav-link js-scroll-trigger"
            href="{{ site.baseurl }}/#{{ link.section }}"
            >{{ link.title }}</a
          >
          {%- else -%}
          <a class="nav-link js-scroll-trigger" href="#">{{ link.title }}</a>
          {%- endif -%}
        </li>
        {%- endfor -%}
      {% endif %}
      </ul>
    </div>
  </div>
</nav>
<!-- End Navigation -->

<style>
/* Override navigation styles for light theme */
#mainNav {
  background: transparent !important;
  backdrop-filter: none !important;
}

#mainNav .navbar-nav .nav-link {
  color: #4b5563 !important;
}

#mainNav .navbar-nav .nav-link:hover {
  color: #3B82F6 !important;
}

#mainNav .navbar-brand {
  color: #1a1a1a !important;
}
</style>

<script>
// Initialize navigation functionality after everything loads
function initNavigation() {
  const dropdownItems = document.querySelectorAll('.navbar-nav .dropdown');
  let activeDropdown = null;
  let timeoutId = null;
  let lastMousePos = { x: 0, y: 0 };
  
  dropdownItems.forEach(dropdown => {
    const menu = dropdown.querySelector('.dropdown-menu');
    
    dropdown.addEventListener('mouseenter', function() {
      clearTimeout(timeoutId);
      
      // Hide other dropdowns
      dropdownItems.forEach(item => {
        if (item !== dropdown) {
          item.querySelector('.dropdown-menu').style.display = 'none';
          item.querySelector('.dropdown-menu').style.opacity = '0';
          
          // Reset other chevrons (both Font Awesome and HTML entity)
          const otherChevron = item.querySelector('i.fa-chevron-down');
          const otherDropdownArrow = item.querySelector('.dropdown-arrow');
          if (otherChevron) {
            otherChevron.style.transform = 'rotate(0deg)';
          }
          if (otherDropdownArrow) {
            otherDropdownArrow.style.transform = 'rotate(0deg)';
          }
        }
      });
      
      // Show current dropdown
      menu.style.display = 'block';
      menu.style.opacity = '1';
      menu.style.transform = 'translateY(0)';
      
      // Rotate chevron (both Font Awesome and HTML entity)
      const chevron = dropdown.querySelector('i.fa-chevron-down');
      const dropdownArrow = dropdown.querySelector('.dropdown-arrow');
      if (chevron) {
        chevron.style.transform = 'rotate(180deg)';
      }
      if (dropdownArrow) {
        dropdownArrow.style.transform = 'rotate(180deg)';
      }
      
      activeDropdown = dropdown;
    });
    
    dropdown.addEventListener('mouseleave', function(e) {
      const rect = menu.getBoundingClientRect();
      const mouseX = e.clientX;
      const mouseY = e.clientY;
      
      // Check if mouse is moving towards the dropdown menu
      const menuLeft = rect.left;
      const menuRight = rect.right;
      const menuTop = rect.top;
      
      const isMovingTowards = mouseX >= menuLeft - 20 && mouseX <= menuRight + 20 && 
                             mouseY >= menuTop - 20;
      
      if (isMovingTowards) {
        // Give more time if moving towards dropdown
        timeoutId = setTimeout(() => {
          if (activeDropdown === dropdown) {
            menu.style.display = 'none';
            menu.style.opacity = '0';
            menu.style.transform = 'translateY(-10px)';
            
            // Reset chevron (both Font Awesome and HTML entity)
            const chevron = dropdown.querySelector('i.fa-chevron-down');
            const dropdownArrow = dropdown.querySelector('.dropdown-arrow');
            if (chevron) {
              chevron.style.transform = 'rotate(0deg)';
            }
            if (dropdownArrow) {
              dropdownArrow.style.transform = 'rotate(0deg)';
            }
            
            activeDropdown = null;
          }
        }, 300); // 300ms delay
      } else {
        // Hide immediately if not moving towards dropdown
        timeoutId = setTimeout(() => {
          if (activeDropdown === dropdown) {
            menu.style.display = 'none';
            menu.style.opacity = '0';
            menu.style.transform = 'translateY(-10px)';
            
            // Reset chevron (both Font Awesome and HTML entity)
            const chevron = dropdown.querySelector('i.fa-chevron-down');
            const dropdownArrow = dropdown.querySelector('.dropdown-arrow');
            if (chevron) {
              chevron.style.transform = 'rotate(0deg)';
            }
            if (dropdownArrow) {
              dropdownArrow.style.transform = 'rotate(0deg)';
            }
            
            activeDropdown = null;
          }
        }, 150);
      }
    });
    
    // Keep dropdown open when hovering over the menu itself
    menu.addEventListener('mouseenter', function() {
      clearTimeout(timeoutId);
    });
    
    menu.addEventListener('mouseleave', function() {
      timeoutId = setTimeout(() => {
        menu.style.display = 'none';
        menu.style.opacity = '0';
        menu.style.transform = 'translateY(-10px)';
        
        // Reset chevron
        const chevron = dropdown.querySelector('i.fa-chevron-down');
        if (chevron) {
          chevron.style.transform = 'rotate(0deg)';
        }
        
        activeDropdown = null;
      }, 150);
    });
  });
  
  // Track mouse movement
  document.addEventListener('mousemove', function(e) {
    lastMousePos.x = e.clientX;
    lastMousePos.y = e.clientY;
  });
  
  // Handle AI chat trigger clicks (both dropdown items and main AI button)
  const aiChatTriggers = document.querySelectorAll('.ai-chat-trigger');
  aiChatTriggers.forEach(trigger => {
    trigger.addEventListener('click', function(e) {
      e.preventDefault();
      if (typeof window.toggleChatbot === 'function') {
        window.toggleChatbot();
      } else {
        console.error('toggleChatbot function not found');
      }
    });
  });
  
  // Handle AI menu circular button clicks (direct AI button) with safer approach
  document.addEventListener('click', function(e) {
    // Use event delegation for AI buttons
    if (e.target.closest('.ai-menu-circular')) {
      e.preventDefault();
      
      // Use setTimeout to avoid blocking other events
      setTimeout(function() {
        // Wait a bit for chatbot to load if not available
        let attempts = 0;
        const tryToggle = () => {
          if (typeof window.toggleChatbot === 'function') {
            window.toggleChatbot();
          } else if (attempts < 5) {
            attempts++;
            setTimeout(tryToggle, 200);
          } else {
            console.error('toggleChatbot function not found after waiting');
          }
        };
        tryToggle();
      }, 10);
    }
  });
}

// Prevent multiple initialization
let navigationInitialized = false;

function safeInitNavigation() {
  if (navigationInitialized) return;
  navigationInitialized = true;
  initNavigation();
}

// Try to initialize immediately
document.addEventListener('DOMContentLoaded', safeInitNavigation);

// Also try after full page load
window.addEventListener('load', function() {
  setTimeout(safeInitNavigation, 500);
});

// Emergency fallback - initialize after a delay
setTimeout(safeInitNavigation, 2000);
</script>
